{% extends 'manati_ui/base.html' %}
{% block title %}
    New Analysis Session - <span id="weblogfile-name"></span>
{% endblock %}
{% block content %}
    <div class="row">
        <div class="col-md-12">
            <form enctype="multipart/form-data" role="form" class="form-inline">
                <div class="form-group">
                   <h4>Add Weblog file</h4>

                </div>
                <div class="form-group">
                    <div class="input-group">
                        <label class="input-group-btn">
                            <span class="btn btn-success">
                                Browse&hellip; <input type="file" style="display: none;" multiple>
                            </span>
                        </label>
                        <input type="text" class="form-control" readonly>
                    </div>
                    <input type="button" id="upload" class="btn btn-default" value="Upload File"/>
                    <input type="button" id="save-table" class="btn btn-primary"  value="Save!" />
                    <progress></progress>

                </div>

            </form>
        </div>
        <div class="col-md-12">
            <div class="panel panel-default" id="panel-datatable">
                <div class="panel-heading">
                    Table of weblogs
{#                    {% load staticfiles %}#}
{#                    <img id="loading" src="{% static 'manati_ui/images/ajax-loader.gif' %}"/>#}
                </div>
                <div class="panel-body">
{#                    <div class="dataTable_wrapper">#}
                        <table class="table table-striped table-bordered table-hover"  cellspacing="0" width="100%" id="weblogs-datatable">
                            <thead>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
{#                    </div>#}
                </div>

            </div>

        </div>

    </div>
    <style>
{#        div.dataTables_wrapper {#}
{#            width: 100%;#}
{#            margin: 0 auto;#}
{#        }#}
        .myFile {
          position: relative;
          overflow: hidden;
          float: left;
          clear: left;
        }
        .myFile input[type="file"] {
          display: block;
          position: absolute;
          top: 0;
          right: 0;
          opacity: 0;
          font-size: 100px;
          filter: alpha(opacity=0);
          cursor: pointer;
        }
    </style>
    <script type="text/javascript">
        var _dt;
        var stepped = 0;
        var rowCount, firstError, errorCount = 0;
        var _keys = [];
        var _filename;
        var _db = new PouchDB('weblogs_db');
{#        var attributes_db = {{ weblogs_attribute|safe }};#}
        var myDjangoList = (("{{weblogs_attribute |safe}}").replace(/&(l|g|quo)t;/g, function(a,b){
            return {
                l   : '<',
                g   : '>',
                quo : '"'
            }[b];
        }));

        myDjangoList = myDjangoList.replace(/u'/g, '\'');
        myDjangoList = myDjangoList.replace(/'/g, '\"');

        var _attributes_db = JSON.parse( myDjangoList );
        function addWeblog(weblog) {

{#          var todo = {#}
{##}
{#            _id: new Date().toISOString(),#}
{#            title: text,#}
{#            completed: false#}
{#          };#}
          weblog['_id'] =  new Date().toISOString()
          _db.put(weblog, function callback(err, result) {
            if (!err) {
              console.log('Successfully save a weblog!');
            }
          });
        };
        function showAllWeblogs() {
          _db.allDocs({include_docs: true, descending: true}, function(err, doc) {
            for(var i = 0 ; i < doc.rows.length ; i++){
                console.log(doc.rows[i]);
            }
          });
        }
        function completeFn(results,file){
            if (results && results.errors)
            {
                if (results.errors)
                {
                    errorCount = results.errors.length;
                    firstError = results.errors[0];
                }
                if (results.data && results.data.length > 0)
                    rowCount = results.data.length;
            }
        }

        function addRowThread(data){
            _dt.row.add(data).draw( false );
            var weblog = {};
            for(var i_attr = 0; i_attr < _keys.length; i_attr++ ){
                var attr = _keys[i_attr];
                weblog[attr] = data[i_attr];
            }
            addWeblog(weblog)
        }
        function stepFn(results, parser)
        {
            stepped++;
            if (results)
            {
                if (results.data){
                    rowCount += results.data.length;
                    var data = results.data[0];
                    if(stepped > 1){
                        Concurrent.Thread.create(addRowThread,data);
                    }else{
                        var columns = [];
                        for(var i = 0; i< data.length ; i++){
                            columns.add({title: data[i]});
                        }
                        _keys = data;
                        _dt = $('#weblogs-datatable').DataTable({
                            lengthChange: true,
                            responsive: true,
                            "scrollX": true,
                            dom: 'Bfrtip',
                            colReorder: true,
                            buttons: ['copy', 'excel', 'pdf','colvis'],
                            columns: columns
                        });
                        _dt.buttons().container().appendTo( '#example_wrapper .col-sm-6:eq(0)' );
                        $('#panel-datatable').show();
                    }

                }

                if (results.errors)
                {
                    errorCount += results.errors.length;
                    firstError = firstError || results.errors[0];
                }
            }
        }
        $(document).ready(function() {

            $('#panel-datatable').hide();
            $('#save-table').hide();
            $('#upload').click(function (){
                 $('input[type=file]').parse({
                    config: {
                        delimiter: ',', // '|',//'\t',
                        complete: completeFn,
                        step: stepFn
                        // base config to use for each file
                    },
                    before: function(file, inputElem)
                    {
                        _filename = file.name;
                        console.log("Parsing file...", file);
                        $("#weblogfile-name").html(file.name)
                    },
                    error: function(err, file, inputElem, reason)
                    {
                        console.log("ERROR:", err, file);
                    },
                    complete: function()
                    {
                        console.log("Done with all files");
                        $('#save-table').show();

                    }
                });
            });
            $(':file').on('fileselect', function(event, numFiles, label) {

                  var input = $(this).parents('.input-group').find(':text'),
                      log = numFiles > 1 ? numFiles + ' files selected' : label;

                  if( input.length ) {
                      input.val(log);
                  } else {
                      if( log ) alert(log);
                  }

              });
            $(document).on('change', ':file', function() {
                var input = $(this),
                    numFiles = input.get(0).files ? input.get(0).files.length : 1,
                    label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
                input.trigger('fileselect', [numFiles, label]);
            });
            $('#save-table').click( function () {
                var data = {    'filename': _filename, 'keys': _keys,
                                'csrfmiddlewaretoken': '{{ csrf_token }}',
                                'data[]': _dt.rows().data() };
                $.ajax({
                    type:"POST",
                    data: data,
                    dataType: "json",
                    url: "/manati_ui/analysis_session/create",
                    // handle a successful response
                    success : function(json) {
{#                        $('#post-text').val(''); // remove the value from the input#}
                        console.log(json); // log the returned json to the console
                        console.log("success"); // another sanity check
                    },

                    // handle a non-successful response
                    error : function(xhr,errmsg,err) {
                        $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                            " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                        console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                    }

                });
            });
{#            $('a.toggle-vis').on( 'click', function (e) {#}
{#                e.preventDefault();#}
{#                // Get the column API object#}
{#                var column = _dt.column( $(this).attr('data-column') );#}
{##}
{#                // Toggle the visibility#}
{#                column.visible( ! column.visible() );#}
{#            } );#}
        });

    </script>
{% endblock %}
