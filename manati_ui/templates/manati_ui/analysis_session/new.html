{% extends 'manati_ui/base.html' %}
{% block title %}
    New Analysis Session - <span id="weblogfile-name"></span>
{% endblock %}
{% block content %}
    <div class="row">
        <div class="col-md-12">
            <form enctype="multipart/form-data" role="form" class="form-inline">
                <div class="form-group">
                   <h4>Add Weblog file</h4>

                </div>
                <div class="form-group">
                    <div class="input-group">
                        <label class="input-group-btn">
                            <span class="btn btn-primary">
                                Browse&hellip; <input type="file" style="display: none;" multiple>
                            </span>
                        </label>
                        <input type="text" class="form-control" readonly>
                    </div>
                    <input type="button" id="upload" class="btn btn-default" value="Upload File"/>
{#                    <progress></progress>#}

                </div>

            </form>
        </div>
        <div class="col-md-12">
            <div class="panel panel-default" id="panel-datatable">
                <div class="panel-heading">
                    Table of weblogs
{#                    {% load staticfiles %}#}
{#                    <img id="loading" src="{% static 'manati_ui/images/ajax-loader.gif' %}"/>#}
                </div>
                <div class="panel-body">
                    <div class="dataTable_wrapper">
                        <table class="table table-striped table-bordered table-hover" id="dataTables-example">
                            <thead>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

        </div>

    </div>
    <style>
        div.dataTables_wrapper {
            width: 100%;
            margin: 0 auto;
        }
        .myFile {
          position: relative;
          overflow: hidden;
          float: left;
          clear: left;
        }
        .myFile input[type="file"] {
          display: block;
          position: absolute;
          top: 0;
          right: 0;
          opacity: 0;
          font-size: 100px;
          filter: alpha(opacity=0);
          cursor: pointer;
        }
    </style>
    <script type="text/javascript">
        var _dt;
        function completeFn(results,file){
            if (results && results.errors)
            {
                if (results.errors)
                {
                    errorCount = results.errors.length;
                    firstError = results.errors[0];
                }
                if (results.data && results.data.length > 0)
                    rowCount = results.data.length;
            }
        }
        var stepped = 0;
        var rowCount, firstError, errorCount = 0;
        function tt(data){
            _dt.row.add(data).draw( false );
        }
        function stepFn(results, parser)
        {
            stepped++;
            if (results)
            {
                if (results.data){
                    rowCount += results.data.length;
                    var data = results.data[0];
                    if(stepped > 1){
                        Concurrent.Thread.create(tt,data);
                    }else{
                        var elem = '<tr>';
                        var elem_tr = '<tr>';
                        for(var i = 0; i< data.length ; i++){
                            elem+='<th>' +data[i]+ '</th>';
                            elem_tr+='<td></td>';
                        }
                        elem+='</tr>';
                        elem_tr+='</tr>';
                        $('#dataTables-example thead').html(elem);
{#                        $('#dataTables-example tbody').html(elem_tr);#}
                        _dt = $('#dataTables-example').DataTable({
                            lengthChange: false,
                            responsive: true,
                            "scrollX": true,
                            dom: 'Bfrtip',
                            colReorder: true,
                            buttons: ['colvis'],
                            "initComplete" : function () {
                                $('#dataTables-example thead').hide();
                            }
                        });
                        _dt.buttons().container().appendTo( '#example_wrapper .col-sm-6:eq(0)' );
                        $('#panel-datatable').show();
                    }

                }

                if (results.errors)
                {
                    errorCount += results.errors.length;
                    firstError = firstError || results.errors[0];
                }
            }
        }
        $(document).ready( function() {
              $(':file').on('fileselect', function(event, numFiles, label) {

                  var input = $(this).parents('.input-group').find(':text'),
                      log = numFiles > 1 ? numFiles + ' files selected' : label;

                  if( input.length ) {
                      input.val(log);
                  } else {
                      if( log ) alert(log);
                  }

              });
        });
        $(document).ready(function() {

            $('#panel-datatable').hide();
            $('#upload').click(function (){
                 $('input[type=file]').parse({
                    config: {
                        delimiter: '\t',
                        complete: completeFn,
                        step: stepFn
                        // base config to use for each file
                    },
                    before: function(file, inputElem)
                    {
                        console.log("Parsing file...", file);
                        $("#weblogfile-name").html(file.name)
                    },
                    error: function(err, file, inputElem, reason)
                    {
                        console.log("ERROR:", err, file);
                    },
                    complete: function()
                    {
                        console.log("Done with all files");

                    }
                });
            });
            $(document).on('change', ':file', function() {
                var input = $(this),
                    numFiles = input.get(0).files ? input.get(0).files.length : 1,
                    label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
                input.trigger('fileselect', [numFiles, label]);
            });
            $('a.toggle-vis').on( 'click', function (e) {
                e.preventDefault();
                // Get the column API object
                var column = table.column( $(this).attr('data-column') );

                // Toggle the visibility
                column.visible( ! column.visible() );
            } );
        });

    </script>
{% endblock %}

{#<h1>{{ question.question_text }}</h1>#}
{##}
{#<ul>#}
{#{% for choice in question.choice_set.all %}#}
{#    <li>{{ choice.choice_text }} -- {{ choice.votes }} vote{{ choice.votes|pluralize }}</li>#}
{#{% endfor %}#}
{#</ul>#}
{##}
{#<a href="{% url 'polls:detail' question.id %}">Vote again?</a>#}
